<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nederlandse Chatbot</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    #chat-window {
      width: 100%;
      max-width: 600px;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      background: white;
    }

    #chat-header {
      background: linear-gradient(135deg, #0078d7 0%, #005a9f 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chat-title {
      font-size: 1.3em;
      font-weight: 600;
    }

    #chat-controls {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background-color: #fafafa;
      scroll-behavior: smooth;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      margin: 8px 0;
    }

    .message-time {
      font-size: 0.75em;
      color: #666;
      margin: 2px 0;
    }

    .user-message-wrapper {
      align-items: flex-end;
    }

    .user-message-wrapper .message-time {
      text-align: right;
    }

    .bot-message-wrapper {
      align-items: flex-start;
    }

    .user-message, .bot-message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 85%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      align-self: flex-end;
    }

    .bot-message {
      background: white;
      color: #333;
      align-self: flex-start;
      border: 1px solid #e1e5e9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .typing-indicator {
      background: white;
      border: 1px solid #e1e5e9;
      padding: 16px;
      border-radius: 18px;
      align-self: flex-start;
      max-width: 85%;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: #666;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    .typing-cursor {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background-color: #4facfe;
      margin-left: 2px;
      animation: cursor-blink 1s infinite;
      vertical-align: text-bottom;
    }

    @keyframes cursor-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
      align-self: flex-start;
      max-width: 85%;
    }

    .quick-reply-btn {
      background: #f1f3f4;
      border: 1px solid #dadce0;
      color: #3c4043;
      padding: 8px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }

    .quick-reply-btn:hover {
      background: #e8f0fe;
      border-color: #4285f4;
      color: #1a73e8;
    }

    #input-area {
      display: flex;
      padding: 16px;
      border-top: 1px solid #e1e5e9;
      background-color: white;
      gap: 10px;
    }

    #user-input {
      flex-grow: 1;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 24px;
      outline: none;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    #user-input:focus {
      border-color: #4285f4;
    }

    #send-button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      min-width: 80px;
    }

    #send-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    #send-button:disabled {
      background: #dadce0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .link-card {
      background: #f8f9fa;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      display: inline-block;
      text-decoration: none;
      color: #1a73e8;
      transition: all 0.2s;
    }

    .link-card:hover {
      background: #e8f0fe;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .error-message {
      background: #fce8e6;
      color: #d93025;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      border-left: 4px solid #d93025;
    }

    /* Mobile responsiveness */
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      #chat-window {
        height: 95vh;
        border-radius: 0;
      }
      
      #chat-header {
        padding: 15px;
      }
      
      #chat-title {
        font-size: 1.1em;
      }
      
      .control-btn {
        padding: 6px 10px;
        font-size: 0.8em;
      }
      
      .user-message, .bot-message {
        max-width: 90%;
        padding: 10px 14px;
      }
      
      #input-area {
        padding: 12px;
      }
      
      #user-input {
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      .typing-dot,
      .typing-cursor {
        animation: none;
      }
      
      * {
        transition: none !important;
      }
    }

    /* Focus indicators for keyboard navigation */
    .control-btn:focus,
    .quick-reply-btn:focus,
    #send-button:focus {
      outline: 2px solid #4285f4;
      outline-offset: 2px;
    }
  </style>
</head>
<body>

  <div id="chat-window" role="main">
    <div id="chat-header">
      <div id="chat-title">Virtuele Assistent</div>
      <div id="chat-controls">
        <button class="control-btn" id="clear-btn" title="Gesprek wissen">üóëÔ∏è Wissen</button>
        <button class="control-btn" id="help-btn" title="Help">‚ùì Help</button>
      </div>
    </div>
    <div id="chat-container" role="log" aria-live="polite" aria-label="Chat berichten"></div>
    <div id="input-area">
      <input 
        type="text" 
        id="user-input" 
        placeholder="Typ uw vraag hier..." 
        autocomplete="off"
        maxlength="500"
        aria-label="Uw bericht"
      >
      <button id="send-button" aria-label="Bericht verzenden">Stuur</button>
    </div>
  </div>

<script>
// ===================================================================================
// ENHANCED DUTCH CHATBOT WITH IMPROVED FEATURES
// ===================================================================================

class EnhancedDutchEliza {
  constructor(qaData) {
    this.qaData = qaData || [];
    this.conversationState = {
      currentTopic: null,
      detailLevel: "short",
      askedFollowUp: false,
      sessionHistory: [],
      userPreferences: new Map(),
      messageCount: 0,
      lastMessageTime: 0
    };

    // Enhanced patterns with better responses
    this.patterns = [
      { regex: /^(hallo|hoi|hey|goedemorgen|goedemiddag|goedenavond)!?$/i, responses: ["Hallo! Hoe kan ik u vandaag helpen?", "Goedendag! Waarmee kan ik u van dienst zijn?", "Hoi! Wat kan ik voor u betekenen?"], quickReplies: ["Openingstijden", "Bezorging", "Retouren"] },
      { regex: /bedankt?|dank(je)?( wel)?|thanks/i, responses: ["Graag gedaan! Is er nog iets anders waarmee ik kan helpen?", "Geen probleem! Heeft u nog andere vragen?", "Fijn dat ik kon helpen! Waarmee kan ik u verder van dienst zijn?"], quickReplies: ["Nog een vraag", "Dat was alles"] },
      { regex: /doei|tot ziens|dag|bye|adios|ciao/i, responses: ["Tot ziens! Kom gerust terug als u meer vragen heeft.", "Dag! Het was prettig om u te helpen.", "Tot de volgende keer! Fijne dag verder."] },
      { regex: /help|hulp|wat kun je|wat kan je/i, responses: ["Ik kan u helpen met vragen over onze diensten, openingstijden, bezorging en retouren. Wat wilt u weten?"], quickReplies: ["Openingstijden", "Bezorging", "Retouren", "Contact"] },
      { regex: /hoe gaat het|hoe is het|alles goed/i, responses: ["Met mij gaat het prima, dank je! Ik ben hier om u te helpen. Wat kan ik voor u doen?"], quickReplies: ["Stel een vraag"] },
      
      // More sophisticated pattern matching
      { regex: /waarom (.*)\?/i, responses: ["Dat is een goede vraag. Voor '$1' zijn er vaak verschillende redenen. Kunt u specifieker zijn?", "Interessant dat u dat vraagt over '$1'. Wat denkt u zelf dat de reden zou kunnen zijn?"] },
      { regex: /hoe (.*)\?/i, responses: ["Voor '$1' kan ik u uitleggen hoe dat werkt. Zoekt u naar stap-voor-stap instructies?", "Goed dat u vraagt naar '$1'. Wilt u een gedetailleerde uitleg?"] },
      { regex: /wat is (.*)\?/i, responses: ["Over '$1' kan ik u meer vertellen. Zoekt u naar een definitie of praktische informatie?"] },
      
      // Conversation flow helpers
      { regex: /ja|graag|zeker|ok(√©)?|goed/i, responses: ["Mooi! Hier is meer informatie voor u:"] },
      { regex: /nee|niet( nodig)?|hoeft niet/i, responses: ["Prima! Waarmee kan ik u dan wel helpen?"], quickReplies: ["Andere vraag", "Openingstijden", "Contact"] },
      { regex: /meer|details|uitleg|vertel meer/i, responses: ["Natuurlijk! Ik geef u graag meer details."] },
    ];

    // Enhanced fallback responses with categories
    this.fallbackResponses = {
      empathetic: [
        "Ik begrijp dat dit belangrijk voor u is. Kunt u me wat meer details geven?",
        "Dat klinkt als een relevante vraag. Kunt u het anders formuleren?",
        "Interessant punt. Welk aspect interesseert u het most?"
      ],
      helpful: [
        "Ik wil u graag helpen, maar begrijp uw vraag niet helemaal. Kunt u het anders stellen?",
        "Om u beter te kunnen helpen, zou u uw vraag kunnen verduidelijken?",
        "Laat me u op een andere manier proberen te helpen. Waar gaat uw vraag precies over?"
      ],
      redirective: [
        "Misschien kan ik u helpen met een van deze onderwerpen:",
        "Ik ken vooral veel over onze diensten. Waar bent u naar op zoek?",
        "Laten we kijken of ik u kan helpen met:"
      ]
    };

    // Rate limiting
    this.rateLimitConfig = {
      maxMessagesPerMinute: 10,
      messageHistory: []
    };

    // Initialize error tracking
    this.errorCount = 0;
    this.maxErrors = 3;
  }

  // Enhanced fuzzy matching with typo tolerance
  calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    const distance = this.levenshteinDistance(longer, shorter);
    return (longer.length - distance) / longer.length;
  }

  levenshteinDistance(str1, str2) {
    const matrix = Array(str2.length + 1).fill().map(() => Array(str1.length + 1).fill(0));
    
    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
    
    for (let j = 1; j <= str2.length; j++) {
      for (let i = 1; i <= str1.length; i++) {
        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
        matrix[j][i] = Math.min(
          matrix[j][i - 1] + 1,
          matrix[j - 1][i] + 1,
          matrix[j - 1][i - 1] + cost
        );
      }
    }
    
    return matrix[str2.length][str1.length];
  }

  // Rate limiting check
  checkRateLimit() {
    const now = Date.now();
    const oneMinuteAgo = now - 60000;
    
    // Clean old messages
    this.rateLimitConfig.messageHistory = this.rateLimitConfig.messageHistory.filter(
      time => time > oneMinuteAgo
    );
    
    if (this.rateLimitConfig.messageHistory.length >= this.rateLimitConfig.maxMessagesPerMinute) {
      return false;
    }
    
    this.rateLimitConfig.messageHistory.push(now);
    return true;
  }

  // Enhanced Q&A matching with fuzzy search
  findRelevantQA(userInput) {
    const normalizedInput = userInput.toLowerCase().trim();
    let bestMatch = { found: false, confidence: 0 };

    // Handle follow-up context
    if (this.conversationState.currentTopic) {
      const moreInfoRegex = /meer|vertel meer|details|ja|graag|uitleg|verder|doorgaan/i;
      if (moreInfoRegex.test(normalizedInput)) {
        const qa = this.qaData.find(item => item.id === this.conversationState.currentTopic);
        if (qa) {
          if (this.conversationState.detailLevel === "short" && qa.fullAnswer) {
            return { 
              found: true, 
              confidence: 1.0, 
              answer: qa.fullAnswer, 
              id: qa.id, 
              detailLevel: "full", 
              url: qa.url, 
              moreInfo: qa.moreInfo,
              quickReplies: qa.quickReplies
            };
          } else if (this.conversationState.detailLevel === "full" && qa.moreInfo) {
            return { 
              found: true, 
              confidence: 1.0, 
              answer: qa.moreInfo, 
              id: qa.id, 
              detailLevel: "more", 
              url: qa.url,
              quickReplies: qa.quickReplies 
            };
          }
        }
      }
    }
    
    // Reset conversation state for new queries
    this.resetConversationState();

    const userKeywords = this.extractKeywords(userInput);
    if (userKeywords.length === 0) return bestMatch;

    // Enhanced matching with similarity scoring
    for (const qa of this.qaData) {
      let totalScore = 0;
      const qaKeywords = [...this.extractKeywords(qa.question), ...(qa.keywords || [])];
      
      // Exact keyword matches
      let exactMatches = 0;
      userKeywords.forEach(userWord => {
        qaKeywords.forEach(qaWord => {
          if (userWord === qaWord) {
            exactMatches += 2; // Higher weight for exact matches
          } else if (qaWord.includes(userWord) || userWord.includes(qaWord)) {
            exactMatches += 1;
          } else {
            // Fuzzy matching for typos
            const similarity = this.calculateSimilarity(userWord, qaWord);
            if (similarity > 0.8) {
              exactMatches += similarity;
            }
          }
        });
      });

      // Calculate confidence with improved algorithm
      const keywordConfidence = exactMatches / Math.max(userKeywords.length, qaKeywords.length);
      
      // Boost confidence for category matches
      const categoryBoost = qa.category && this.detectCategory(userInput) === qa.category ? 0.2 : 0;
      
      // Priority boost
      const priorityBoost = qa.priority === "high" ? 0.1 : 0;
      
      totalScore = keywordConfidence + categoryBoost + priorityBoost;
      
      if (totalScore > bestMatch.confidence && totalScore > 0.3) {
        bestMatch = {
          found: true,
          answer: qa.shortAnswer,
          confidence: totalScore,
          id: qa.id,
          detailLevel: "short",
          followUp: qa.followUp,
          url: qa.url,
          fullAnswer: qa.fullAnswer,
          moreInfo: qa.moreInfo,
          quickReplies: qa.quickReplies,
          category: qa.category
        };
      }
    }

    return bestMatch;
  }

  // Simple category detection
  detectCategory(input) {
    const serviceKeywords = ['open', 'tijd', 'wanneer', 'uur'];
    const deliveryKeywords = ['bezorg', 'lever', 'verzend', 'verstuur'];
    const returnKeywords = ['retour', 'terug', 'ruil', 'geld'];
    
    const normalized = input.toLowerCase();
    
    if (serviceKeywords.some(keyword => normalized.includes(keyword))) return 'service';
    if (deliveryKeywords.some(keyword => normalized.includes(keyword))) return 'delivery';  
    if (returnKeywords.some(keyword => normalized.includes(keyword))) return 'returns';
    
    return null;
  }

  // Enhanced keyword extraction
  extractKeywords(text) {
    const commonWords = [
      'de','het','een','en','van','in','op','aan','met','voor','door','is','zijn','was',
      'ik','je','u','hij','zij','wij','jullie','hoe','wat','waar','wie','waarom','welke',
      'of','dat','dit','deze','die','hebben','kan','willen','zou','zal','moet','mag','wil'
    ];
    
    return text
      .toLowerCase()
      .replace(/[^\w\s√†√°√¢√§√®√©√™√´√¨√≠√Æ√Ø√≤√≥√¥√∂√π√∫√ª√º√±√ß]/g, '')
      .split(/\s+/)
      .filter(word => word.length > 2 && !commonWords.includes(word))
      .slice(0, 10); // Limit to prevent performance issues
  }

  // Enhanced response generation with error handling
  generateResponse(userInput) {
    try {
      // Input validation
      if (!userInput || userInput.trim().length === 0) {
        return "Ik heb geen bericht van u ontvangen. Kunt u uw vraag opnieuw stellen?";
      }

      if (userInput.length > 500) {
        return "Dat is een erg lange vraag! Kunt u het korter formuleren zodat ik u beter kan helpen?";
      }

      // Rate limiting
      if (!this.checkRateLimit()) {
        return "U stelt erg veel vragen achter elkaar. Neemt u even een pauze en probeer het over een minuut opnieuw.";
      }

      // Update conversation statistics
      this.conversationState.messageCount++;
      this.conversationState.lastMessageTime = Date.now();

      // 1. Try Q&A database first
      const qaMatch = this.findRelevantQA(userInput);
      if (qaMatch.found) {
        this.conversationState.currentTopic = qaMatch.id;
        this.conversationState.detailLevel = qaMatch.detailLevel;
        
        let response = qaMatch.answer;

        // Add follow-up questions intelligently
        if (qaMatch.detailLevel === "short" && qaMatch.followUp) {
          response += `\n\n${qaMatch.followUp}`;
          this.conversationState.askedFollowUp = true;
        } else if (qaMatch.detailLevel === "full" && qaMatch.moreInfo) {
          response += `\n\nWilt u nog meer details over dit onderwerp?`;
          this.conversationState.askedFollowUp = true;
        }
        
        // Add URL as formatted link
        if (qaMatch.url && (qaMatch.detailLevel === "full" || qaMatch.detailLevel === "more")) {
          response += `\n\nüìé Meer informatie: ${qaMatch.url}`;
        }
        
        return {
          text: response,
          quickReplies: qaMatch.quickReplies,
          category: qaMatch.category
        };
      }
      
      // 2. Try pattern matching
      for (const pattern of this.patterns) {
        const match = userInput.match(pattern.regex);
        if (match) {
          const response = this.randomChoice(pattern.responses);
          let finalResponse = response;
          
          if (match[1]) {
            finalResponse = this.fixDutchGrammar(response, match[1]);
          }
          
          return {
            text: finalResponse,
            quickReplies: pattern.quickReplies
          };
        }
      }
      
      // 3. Fallback with context-aware responses
      const fallbackType = this.conversationState.messageCount > 3 ? 'helpful' : 'empathetic';
      let fallbackResponse = this.randomChoice(this.fallbackResponses[fallbackType]);
      
      // Add topic suggestions for redirective responses
      if (fallbackType === 'redirective' || Math.random() > 0.7) {
        return {
          text: fallbackResponse,
          quickReplies: ["Openingstijden", "Bezorging", "Retouren", "Contact"]
        };
      }
      
      return { text: fallbackResponse };

    } catch (error) {
      console.error('Error generating response:', error);
      this.errorCount++;
      
      if (this.errorCount >= this.maxErrors) {
        return "Er zijn wat technische problemen. Probeer de pagina te vernieuwen.";
      }
      
      return "Sorry, er ging iets mis. Kunt u uw vraag opnieuw stellen?";
    }
  }

  // Enhanced Dutch grammar fixes
  fixDutchGrammar(response, capturedText) {
    let subjectAndRest = capturedText.trim();
    let verb = '';
    
    const verbMap = ['is', 'zijn', 'heeft', 'hebben', 'kan', 'kunnen', 'wil', 'willen', 'moet', 'moeten'];
    
    for (const v of verbMap) {
      if (subjectAndRest.toLowerCase().startsWith(v + ' ')) {
        verb = v;
        subjectAndRest = subjectAndRest.substring(v.length + 1);
        break;
      }
    }
    
    if (verb) {
      const restructuredText = subjectAndRest + ' ' + verb;
      return response.replace(/\$1/g, restructuredText);
    }
    
    return response.replace(/\$1/g, capturedText);
  }

  resetConversationState() {
    this.conversationState.currentTopic = null;
    this.conversationState.detailLevel = "short";
    this.conversationState.askedFollowUp = false;
  }

  clearSession() {
    this.conversationState = {
      currentTopic: null,
      detailLevel: "short", 
      askedFollowUp: false,
      sessionHistory: [],
      userPreferences: new Map(),
      messageCount: 0,
      lastMessageTime: 0
    };
    this.errorCount = 0;
    this.rateLimitConfig.messageHistory = [];
  }
  
  randomChoice(array) {
    return array[Math.floor(Math.random() * array.length)];
  }

  // Get help information
  getHelpInfo() {
    return {
      text: `Ik ben uw virtuele assistent en kan helpen met:\n\n‚Ä¢ Openingstijden en contactgegevens\n‚Ä¢ Bezorging en verzendkosten\n‚Ä¢ Retouren en ruilen\n‚Ä¢ Algemene vragen over onze service\n\nTyp gewoon uw vraag in normale taal, ik begrijp u wel!`,
      quickReplies: ["Openingstijden", "Bezorging", "Retouren"]
    };
  }
}

// ===================================================================================
// ENHANCED Q&A DATA WITH CATEGORIES AND PRIORITIES
// ===================================================================================

const websiteQA = [
  {
    id: "openingstijden",
    category: "service",
    priority: "high",
    question: "Wat zijn de openingstijden?",
    keywords: ["open", "geopend", "tijden", "uur", "wanneer", "bezoeken", "sluit", "dicht"],
    shortAnswer: "We zijn geopend van maandag t/m zaterdag. Op zondag zijn we gesloten.",
    followUp: "Wilt u de precieze tijden per dag weten?",
    fullAnswer: "Onze openingstijden zijn:\n‚Ä¢ Maandag tot vrijdag: 9:00 - 18:00\n‚Ä¢ Zaterdag: 10:00 - 17:00\n‚Ä¢ Zondag: gesloten",
    moreInfo: "Tijdens feestdagen kunnen de openingstijden afwijken:\n‚Ä¢ Koningsdag: gesloten\n‚Ä¢ Kerst en Nieuwjaar: aangepaste tijden\n‚Ä¢ Andere feestdagen: normale tijden\n\nControleer altijd onze website voor actuele informatie tijdens feestperiodes.",
    url: "/contact",
    quickReplies: ["Contact info", "Locatie", "Andere vraag"]
  },
  {
    id: "bezorging",
    category: "delivery", 
    priority: "high",
    question: "Bezorgen jullie ook?",
    keywords: ["levering", "bezorgen", "thuis", "verzenden", "versturen", "pakket", "post", "shipping"],
    shortAnswer: "Jazeker! We bezorgen bestellingen binnen heel Nederland en Belgi√´.",
    followUp: "Wilt u meer weten over de verzendkosten en levertijden?",
    fullAnswer: "Bezorging details:\n‚Ä¢ Gratis verzending vanaf ‚Ç¨50\n‚Ä¢ Onder ‚Ç¨50: ‚Ç¨4,95 verzendkosten\n‚Ä¢ Levertijd: 1-2 werkdagen\n‚Ä¢ Bezorging in Nederland en Belgi√´",
    moreInfo: "Extra service opties:\n‚Ä¢ Express levering (volgende dag): ‚Ç¨7,95 extra\n‚Ä¢ Bezorging op specifiek tijdstip: ‚Ç¨9,95 extra\n‚Ä¢ Ophaalservice bij PostNL punt: gratis\n‚Ä¢ Track & Trace altijd inbegrepen\n‚Ä¢ Veilige verpakking gegarandeerd",
    url: "/verzending",
    quickReplies: ["Track & Trace", "Express levering", "Ophaal punten"]
  },
  {
    id: "retouren",
    category: "returns",
    priority: "high", 
    question: "Kan ik een product retourneren?",
    keywords: ["retourneren", "terugsturen", "ruilen", "geld terug", "teruggave", "retour", "ruilservice"],
    shortAnswer: "Ja, u heeft 14 dagen bedenktijd om een product kosteloos te retourneren.",
    followUp: "Wilt u weten hoe het retourproces werkt?",
    fullAnswer: "Retour proces:\n1. Email naar retouren@voorbeeld.nl met bestelnummer\n2. U krijgt een gratis retourlabel\n3. Verpak het product in originele staat\n4. Verstuur met bijgeleverd label",
    moreInfo: "Belangrijke retour informatie:\n‚Ä¢ Product moet ongebruikt zijn\n‚Ä¢ Originele verpakking vereist\n‚Ä¢ Terugbetaling binnen 5 werkdagen\n‚Ä¢ Hygi√´ne artikelen uitgezonderd\n‚Ä¢ Retour formulier invullen\n‚Ä¢ Foto's maken voor eigen administratie",
    url: "/retouren", 
    quickReplies: ["Retour aanvragen", "Ruil mogelijk?", "Status controleren"]
  },
  {
    id: "contact",
    category: "service",
    priority: "medium",
    question: "Hoe kan ik contact opnemen?", 
    keywords: ["contact", "bellen", "mail", "bereiken", "klantenservice", "telefoon", "email"],
    shortAnswer: "U kunt ons bereiken via telefoon, email of onze contactpagina.",
    followUp: "Wilt u de contactgegevens?",
    fullAnswer: "Contactmogelijkheden:\n‚Ä¢ Telefoon: 020-123-4567 (ma-vr 9-17u)\n‚Ä¢ Email: info@voorbeeld.nl\n‚Ä¢ Whatsapp: 06-12345678\n‚Ä¢ Live chat op website",
    moreInfo: "Extra contact opties:\n‚Ä¢ Social media: Facebook, Instagram\n‚Ä¢ Bezoekadres: Hoofdstraat 123, Amsterdam\n‚Ä¢ Parking beschikbaar voor bezoek\n‚Ä¢ Ook bereikbaar via contactformulier\n‚Ä¢ Gemiddelde reactietijd email: 2 uur",
    url: "/contact",
    quickReplies: ["Telefoonnummer", "Email adres", "Adres"]
  },
  {
    id: "betalen",
    category: "service", 
    priority: "medium",
    question: "Welke betaalmethoden accepteren jullie?",
    keywords: ["betalen", "betaling", "ideal", "creditcard", "paypal", "bancontact", "klarna"],
    shortAnswer: "We accepteren alle gangbare betaalmethoden zoals iDEAL, creditcard en PayPal.",
    followUp: "Wilt u alle beschikbare betaalmethoden zien?",
    fullAnswer: "Beschikbare betaalmethoden:\n‚Ä¢ iDEAL (alle Nederlandse banken)\n‚Ä¢ Creditcard (Visa, Mastercard, Amex)\n‚Ä¢ PayPal\n‚Ä¢ Bancontact (Belgi√´)\n‚Ä¢ Apple Pay & Google Pay",
    moreInfo: "Extra betalingsinformatie:\n‚Ä¢ Achteraf betalen met Klarna mogelijk\n‚Ä¢ Geen extra kosten voor de meeste betalingen\n‚Ä¢ Creditcard: kleine transactiekosten\n‚Ä¢ Betalingen zijn beveiligd met SSL\n‚Ä¢ Direct betalingsbevestiging via email",
    url: "/betaling",
    quickReplies: ["Achteraf betalen", "Veiligheid", "Kosten"]
  }
];

// ===================================================================================
// ENHANCED UI WITH ACCESSIBILITY AND MODERN FEATURES  
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {
  const chatContainer = document.getElementById('chat-container');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const clearButton = document.getElementById('clear-btn');
  const helpButton = document.getElementById('help-btn');
  
  // Create enhanced chatbot instance
  const chatbot = new EnhancedDutchEliza(websiteQA);
  
  // Conversation state
  let isTyping = false;
  let messageCounter = 0;

  // Enhanced message creation with timestamps and accessibility
  function addMessage(content, isUser, options = {}) {
    const messageId = `message-${++messageCounter}`;
    const wrapper = document.createElement('div');
    wrapper.className = isUser ? 'message-wrapper user-message-wrapper' : 'message-wrapper bot-message-wrapper';
    wrapper.setAttribute('id', messageId);
    
    // Add timestamp
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('nl-NL', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    timeDiv.setAttribute('aria-label', `Bericht verzonden om ${timeDiv.textContent}`);
    
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'user-message' : 'bot-message';
    messageDiv.setAttribute('role', isUser ? 'log' : 'status');
    messageDiv.setAttribute('aria-label', isUser ? 'Uw bericht' : 'Antwoord van assistent');
    
    wrapper.appendChild(timeDiv);
    wrapper.appendChild(messageDiv);
    
    if (isUser) {
      messageDiv.textContent = typeof content === 'string' ? content : content.text;
      chatContainer.appendChild(wrapper);
      scrollToBottom();
    } else {
      chatContainer.appendChild(wrapper);
      if (options.showTyping !== false) {
        showTypingIndicator();
        setTimeout(() => {
          hideTypingIndicator();
          typeMessage(messageDiv, content, () => {
            // Add quick replies if available
            if (content.quickReplies && content.quickReplies.length > 0) {
              addQuickReplies(content.quickReplies);
            }
            enableInput();
            scrollToBottom();
          });
        }, 400 + Math.random() * 600);
      } else {
        typeMessage(messageDiv, content, () => {
          if (content.quickReplies && content.quickReplies.length > 0) {
            addQuickReplies(content.quickReplies);
          }
          enableInput();
          scrollToBottom();
        });
      }
    }
    
    // Accessibility: announce new messages to screen readers
    if (!isUser) {
      setTimeout(() => {
        messageDiv.setAttribute('aria-live', 'polite');
      }, 100);
    }
  }

  // Enhanced typing animation with better performance
  function typeMessage(element, content, callback) {
    const text = typeof content === 'string' ? content : content.text;
    const parts = text.split(/(\n\n|https?:\/\/[^\s]+|\/[a-zA-Z0-9\/-_]+)/);
    let currentPart = 0;
    let currentChar = 0;
    let displayText = '';
    
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    element.appendChild(cursor);

    function typeNextChar() {
      if (currentPart >= parts.length) {
        finishTyping(element, text, callback);
        return;
      }

      const part = parts[currentPart];
      
      if (part.match(/^https?:\/\//) || part.match(/^\/[a-zA-Z0-9\/-_]+$/)) {
        // Handle URLs instantly
        displayText += part;
        element.innerHTML = formatMessage(displayText);
        element.appendChild(cursor);
        currentPart++;
        currentChar = 0;
        setTimeout(typeNextChar, 200);
      } else if (part === '\n\n') {
        // Handle paragraph breaks
        displayText += part;
        element.innerHTML = formatMessage(displayText);
        element.appendChild(cursor);
        currentPart++;
        currentChar = 0;
        setTimeout(typeNextChar, 400);
      } else if (currentChar < part.length) {
        // Type regular text character by character
        displayText += part[currentChar];
        element.innerHTML = formatMessage(displayText);
        element.appendChild(cursor);
        currentChar++;
        
        const delay = /[.!?]/.test(part[currentChar - 1]) ? 300 : 
                     /[,;:]/.test(part[currentChar - 1]) ? 150 :
                     20 + Math.random() * 40;
        setTimeout(typeNextChar, delay);
      } else {
        // Move to next part
        currentPart++;
        currentChar = 0;
        setTimeout(typeNextChar, 100);
      }
    }

    // Start typing
    setTimeout(typeNextChar, 100);
  }

  function formatMessage(text) {
    return text
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>')
      .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener" class="link-card">üîó $1</a>')
      .replace(/(\/[a-zA-Z0-9\/-_]+)/g, '<a href="$1" target="_blank" class="link-card">üìÑ $1</a>')
      .replace(/‚Ä¢\s/g, '<span style="color: #4285f4;">‚Ä¢</span> ');
  }

  function finishTyping(element, originalText, callback) {
    // Remove cursor
    const cursor = element.querySelector('.typing-cursor');
    if (cursor) cursor.remove();
    
    // Set final formatted content
    element.innerHTML = formatMessage(originalText);
    
    if (callback) callback();
  }

  // Typing indicator
  function showTypingIndicator() {
    if (document.getElementById('typing-indicator')) return;
    
    const indicator = document.createElement('div');
    indicator.id = 'typing-indicator';
    indicator.className = 'typing-indicator';
    indicator.setAttribute('aria-label', 'Assistent is aan het typen');
    indicator.innerHTML = `
      <span>Assistent typt</span>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    
    chatContainer.appendChild(indicator);
    scrollToBottom();
  }

  function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
      indicator.remove();
    }
  }

  // Quick replies functionality
  function addQuickReplies(replies) {
    removeExistingQuickReplies();
    
    const quickRepliesContainer = document.createElement('div');
    quickRepliesContainer.className = 'quick-replies';
    quickRepliesContainer.setAttribute('aria-label', 'Snelle antwoord opties');
    
    replies.forEach((reply, index) => {
      const button = document.createElement('button');
      button.className = 'quick-reply-btn';
      button.textContent = reply;
      button.setAttribute('tabindex', '0');
      button.setAttribute('aria-label', `Snelle reactie: ${reply}`);
      
      button.addEventListener('click', () => {
        handleQuickReply(reply);
      });
      
      button.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleQuickReply(reply);
        }
      });
      
      quickRepliesContainer.appendChild(button);
    });
    
    chatContainer.appendChild(quickRepliesContainer);
    scrollToBottom();
  }

  function removeExistingQuickReplies() {
    const existing = chatContainer.querySelectorAll('.quick-replies');
    existing.forEach(el => el.remove());
  }

  function handleQuickReply(reply) {
    removeExistingQuickReplies();
    addMessage(reply, true);
    disableInput();
    
    setTimeout(() => {
      const response = chatbot.generateResponse(reply);
      addMessage(response, false);
    }, 300);
  }

  // Input management
  function handleUserInput() {
    const text = userInput.value.trim();
    if (!text || isTyping) return;
    
    removeExistingQuickReplies();
    addMessage(text, true);
    userInput.value = '';
    disableInput();
    
    // Generate response
    setTimeout(() => {
      try {
        const response = chatbot.generateResponse(text);
        addMessage(response, false);
      } catch (error) {
        console.error('Error:', error);
        addMessage("Sorry, er ging iets mis. Probeer het opnieuw.", false, { showTyping: false });
        enableInput();
      }
    }, 200);
  }

  function disableInput() {
    isTyping = true;
    userInput.disabled = true;
    sendButton.disabled = true;
    userInput.placeholder = "Assistent is aan het typen...";
  }

  function enableInput() {
    isTyping = false;
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.placeholder = "Typ uw vraag hier...";
    userInput.focus();
  }

  function scrollToBottom() {
    chatContainer.scrollTo({
      top: chatContainer.scrollHeight,
      behavior: 'smooth'
    });
  }

  // Clear conversation
  function clearConversation() {
    if (confirm('Weet u zeker dat u het gesprek wilt wissen?')) {
      chatContainer.innerHTML = '';
      chatbot.clearSession();
      messageCounter = 0;
      
      // Show welcome message again
      setTimeout(() => {
        const welcomeResponse = chatbot.generateResponse("hallo");
        addMessage(welcomeResponse, false);
      }, 300);
    }
  }

  // Show help
  function showHelp() {
    removeExistingQuickReplies();
    const helpInfo = chatbot.getHelpInfo();
    addMessage(helpInfo, false);
  }

  // Event listeners
  sendButton.addEventListener('click', handleUserInput);
  clearButton.addEventListener('click', clearConversation);
  helpButton.addEventListener('click', showHelp);
  
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleUserInput();
    }
  });

  // Character counter (visual feedback)
  userInput.addEventListener('input', (e) => {
    const length = e.target.value.length;
    const maxLength = 500;
    
    if (length > maxLength * 0.9) {
      e.target.style.borderColor = length >= maxLength ? '#d93025' : '#ff9800';
    } else {
      e.target.style.borderColor = '#e1e5e9';
    }
  });

  // Accessibility improvements
  document.addEventListener('keydown', (e) => {
    // Quick keyboard shortcuts
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'k':
          e.preventDefault();
          clearConversation();
          break;
        case '/':
          e.preventDefault();
          userInput.focus();
          break;
      }
    }
    
    // Escape key to cancel typing
    if (e.key === 'Escape' && isTyping) {
      hideTypingIndicator();
      enableInput();
    }
  });

  // Auto-focus on input when page loads
  setTimeout(() => {
    userInput.focus();
  }, 100);

  // Start conversation with welcome message
  setTimeout(() => {
    const welcomeResponse = chatbot.generateResponse("hallo");
    addMessage(welcomeResponse, false);
  }, 800);

  // Add some initial loading animation
  document.getElementById('chat-window').style.opacity = '0';
  document.getElementById('chat-window').style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    document.getElementById('chat-window').style.transition = 'all 0.5s ease';
    document.getElementById('chat-window').style.opacity = '1';
    document.getElementById('chat-window').style.transform = 'translateY(0)';
  }, 100);
});

</script>

</body>
</html>