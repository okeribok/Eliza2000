<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wegwijzer AI Handreiking</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    #chat-window {
      width: 100%;
      max-width: 600px;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      background: white;
    }

    #chat-header {
      background: linear-gradient(135deg, #0078d7 0%, #005a9f 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chat-title {
      font-size: 1.3em;
      font-weight: 600;
    }

    #chat-controls {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background-color: #fafafa;
      scroll-behavior: smooth;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      margin: 8px 0;
    }

    .message-time {
      font-size: 0.75em;
      color: #666;
      margin: 2px 0;
    }

    .user-message-wrapper { align-items: flex-end; }
    .user-message-wrapper .message-time { text-align: right; }
    .bot-message-wrapper { align-items: flex-start; }

    .user-message, .bot-message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 85%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      align-self: flex-end;
    }

    .bot-message {
      background: white;
      color: #333;
      align-self: flex-start;
      border: 1px solid #e1e5e9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .typing-indicator {
      background: white;
      border: 1px solid #e1e5e9;
      padding: 16px;
      border-radius: 18px;
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .typing-dots { display: flex; gap: 4px; }
    .typing-dot {
      width: 6px; height: 6px; background: #666; border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }
    
    .typing-cursor {
      display: inline-block; width: 2px; height: 1.2em; background-color: #4facfe;
      margin-left: 2px; animation: cursor-blink 1s infinite; vertical-align: text-bottom;
    }
    @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-self: flex-start;
      max-width: 100%;
    }

    .quick-reply-btn {
      background: #f1f3f4;
      border: 1px solid #dadce0;
      color: #3c4043;
      padding: 8px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }

    .quick-reply-btn:hover {
      background: #e8f0fe;
      border-color: #4285f4;
      color: #1a73e8;
    }
    
    #input-area {
      display: flex; padding: 16px; border-top: 1px solid #e1e5e9;
      background-color: white; gap: 10px;
    }

    #user-input {
      flex-grow: 1; padding: 12px 16px; border: 2px solid #e1e5e9;
      border-radius: 24px; outline: none; font-size: 16px; transition: border-color 0.2s;
    }
    #user-input:focus { border-color: #4285f4; }

    #send-button {
      padding: 12px 20px; background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
      color: white; border: none; border-radius: 24px;
      cursor: pointer; font-weight: 600; transition: all 0.2s; min-width: 80px;
    }
    #send-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }
    #send-button:disabled {
      background: #dadce0; cursor: not-allowed;
      transform: none; box-shadow: none;
    }
    a.link-card {
        display: block; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 8px;
        padding: 12px; margin-top: 8px; text-decoration: none; color: #1a73e8; transition: all 0.2s;
    }
    a.link-card:hover {
        background: #e8f0fe; border-color: #a3c5fb;
    }
  </style>
</head>
<body>

  <div id="chat-window" role="main">
    <div id="chat-header">
      <div id="chat-title">Wegwijzer AI Handreiking</div>
      <div id="chat-controls">
        <button class="control-btn" id="clear-btn" title="Gesprek wissen">üóëÔ∏è Wissen</button>
        <button class="control-btn" id="help-btn" title="Help">‚ùì Help</button>
        <button class="control-btn" id="email-btn" onclick="emailConversation()" title="Mail dit gesprek naar een medewerker">üìß Mail een medewerker</button>
      </div>
    </div>
    <div id="chat-container" role="log" aria-live="polite" aria-label="Chat berichten"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="Typ uw vraag hier..." autocomplete="off">
      <button id="send-button" aria-label="Bericht verzenden">Stuur</button>
    </div>
  </div>

<script>
// ===================================================================================
// CHATBOT LOGIC (REFACTORED FOR NO DEAD ENDS)
// ===================================================================================

class EnhancedDutchEliza {
  constructor(qaData) {
    this.qaData = qaData;
    this.qaDataMap = new Map(qaData.map(item => [item.id, item]));
    this.conversationState = {
        activeActions: [],
    };

    this.patterns = [
      { 
        regex: /^(hallo|hoi|hey|goedemorgen|goedemiddag|goedenavond)!?$/i, 
        isGreeting: true,
        response: {
          text: "Hallo! Ik ben de Wegwijzer voor de Overheidsbrede handreiking Generatieve AI. Hoe kan ik u helpen?",
          actions: [
            { text: "Mag ik AI gebruiken?", nextId: "ambtenaar-mag-ik-ai-gebruiken" },
            { text: "Doel van de handreiking", nextId: "ambtenaar-scope-handreiking" },
            { text: "Tips voor prompts", nextId: "ambtenaar-prompt-tips" }
          ]
        }
      },
      { regex: /help|hulp/i, isHelpRequest: true }
    ];

    this.fallbackResponse = {
        text: "Ik kan daar geen direct antwoord op vinden in de handreiking. Misschien is uw vraag gerelateerd aan een van deze hoofdonderwerpen?",
        actions: [
            { text: "Juridische aspecten", nextId: "governance-ai-verordening" },
            { text: "Ethische risico's", nextId: "governance-bias-discriminatie" },
            { text: "Praktische tips", nextId: "ambtenaar-prompt-tips" }
        ]
    };
  }

  findRelevantQA(userInput) {
    const userKeywords = this.extractKeywords(userInput);
    if (userKeywords.length === 0) return null;

    let bestMatch = { score: 0, item: null };

    for (const item of this.qaData) {
      const itemKeywords = [...this.extractKeywords(item.question), ...(item.keywords || [])];
      let score = 0;
      userKeywords.forEach(userWord => {
        itemKeywords.forEach(itemWord => {
          if (userWord === itemWord) score += 2;
          else if (itemWord.includes(userWord)) score += 1;
        });
      });
      
      const confidence = score / (userKeywords.length + itemKeywords.length);
      
      if (confidence > bestMatch.score && confidence > 0.35) {
        bestMatch = { score: confidence, item: item };
      }
    }
    return bestMatch.item;
  }
  
  extractKeywords(text) {
    const commonWords = ['de','het','een','en','van','in','op','aan','met','voor','door','is','zijn','was','ik','je','u','hij','zij','wij','jullie','hoe','wat','waar','wie','waarom','welke','of','dat','dit'];
    return text.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(word => word.length > 2 && !commonWords.includes(word));
  }

  generateResponse(userInput) {
    // 1. Check if the input exactly matches an active action button. This is top priority.
    const actionMatch = this.conversationState.activeActions.find(
      action => action.text.toLowerCase() === userInput.toLowerCase()
    );
    if (actionMatch) {
      const nextItem = this.qaDataMap.get(actionMatch.nextId);
      if (nextItem) {
        this.conversationState.activeActions = nextItem.actions || [];
        return { answer: nextItem.shortAnswer, ...nextItem };
      }
    }
    
    // 2. Check for standard patterns like "hallo" or "help".
    for (const pattern of this.patterns) {
      if (pattern.regex.test(userInput)) {
        if (pattern.isHelpRequest) return this.getHelpInfo();
        if (pattern.isGreeting) {
            this.conversationState.activeActions = pattern.response.actions || [];
            return pattern.response;
        }
      }
    }

    // 3. If no action or pattern matches, search the main Q&A database.
    const qaItem = this.findRelevantQA(userInput);
    if (qaItem) {
        this.conversationState.activeActions = qaItem.actions || [];
        return { answer: qaItem.shortAnswer, ...qaItem };
    }

    // 4. If nothing is found, provide a helpful fallback with actions.
    this.conversationState.activeActions = this.fallbackResponse.actions || [];
    return this.fallbackResponse;
  }

  getHelpInfo() {
    const helpResponse = {
      text: `Ik ben uw Wegwijzer voor de AI Handreiking. U kunt mij vragen stellen over de inhoud, bijvoorbeeld over:\n\n‚Ä¢ Juridische kaders (AVG, AI-verordening)\n‚Ä¢ Ethische risico's (bias, transparantie)\n‚Ä¢ Praktische tips voor het gebruik van AI\n‚Ä¢ Governance en verantwoordelijkheden`,
      actions: [
        { text: "Mag ik AI gebruiken?", nextId: "ambtenaar-mag-ik-ai-gebruiken" },
        { text: "Wat is een risicoanalyse?", nextId: "governance-risicoanalyse-verplicht" },
        { text: "Tips voor prompts", nextId: "ambtenaar-prompt-tips" }
      ]
    };
    this.conversationState.activeActions = helpResponse.actions;
    return helpResponse;
  }

  clearSession() {
      this.conversationState.activeActions = [];
  }
}

// ===================================================================================
// Q&A DATASET (RESTRUCTURED FOR NO DEAD ENDS)
// ===================================================================================

const websiteQA = [
  {
    id: "ambtenaar-mag-ik-ai-gebruiken",
    question: "Mag ik generatieve AI gebruiken voor mijn werk?",
    keywords: ["mag", "gebruiken", "toegestaan", "inzetten", "ai", "chatgpt", "werk"],
    shortAnswer: "Ja, u mag generatieve AI gebruiken als hulpmiddel voor taken met een laag risico, mits u geen gevoelige of persoonsgegevens invoert en er altijd menselijke controle is.",
    actions: [
        { text: "Voor welke taken?", nextId: "ambtenaar-toepassingen" },
        { text: "Wat zijn de 3 hoofdregels?", nextId: "ambtenaar-regels-samenvatting" }
    ]
  },
  {
    id: "ambtenaar-regels-samenvatting",
    question: "Wat zijn de belangrijkste regels bij het gebruik van AI?",
    keywords: ["regels", "samenvatting", "belangrijkste", "voorwaarden"],
    shortAnswer: "De drie belangrijkste regels zijn:\n1. Voer nooit persoonsgegevens of gevoelige informatie in.\n2. Neem de output nooit klakkeloos over (menselijke controle).\n3. Wees bewust van auteursrecht en de betrouwbaarheid van de output.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=22",
    actions: [
        { text: "Risico's persoonsgegevens", nextId: "ambtenaar-persoonsgegevens-gebruiken" },
        { text: "Betrouwbaarheid (hallucineren)", nextId: "ambtenaar-betrouwbaarheid-hallucineren" },
        { text: "Auteursrecht uitgelegd", nextId: "ambtenaar-auteursrecht" }
    ]
  },
  {
    id: "ambtenaar-scope-handreiking",
    question: "Wat is het doel van deze handreiking voor mij als ambtenaar?",
    keywords: ["doel", "scope", "handreiking", "document", "waarom"],
    shortAnswer: "De handreiking geeft u als ambtenaar direct inzetbare handvatten om generatieve AI op een verantwoorde manier te gebruiken in uw werk.",
    actions: [
        { text: "Is de handreiking bindend?", nextId: "ambtenaar-handreiking-bindend" },
        { text: "Welke onderwerpen behandelt het?", nextId: "ambtenaar-handreiking-onderwerpen" }
    ]
  },
  {
    id: "ambtenaar-handreiking-bindend",
    question: "Is de handreiking bindend?",
    keywords: ["bindend", "verplicht", "regels", "wet"],
    shortAnswer: "Nee, het document is niet-bindend en legt geen nieuwe verplichtingen op. Het is bedoeld als een direct bruikbaar hulpmiddel en praktische gids.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=5",
    actions: [ {text: "Terug naar hoofdonderwerpen", nextId: "help-info"} ]
  },
  {
    id: "ambtenaar-handreiking-onderwerpen",
    question: "Welke onderwerpen behandelt de handreiking?",
    keywords: ["onderwerpen", "inhoud", "hoofdstukken"],
    shortAnswer: "De handreiking behandelt de technologische, organisatorische, ethische en juridische voorwaarden voor de verantwoorde inzet van generatieve AI, van experiment tot toepassing.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=5",
    actions: [
        { text: "Juridische aspecten", nextId: "governance-ai-verordening" },
        { text: "Ethische risico's", nextId: "governance-bias-discriminatie" },
        { text: "Governance", nextId: "governance-governancestructuur-opzetten" }
    ]
  },
  {
    id: "governance-risicoanalyse-verplicht",
    question: "Is het uitvoeren van een risicoanalyse verplicht voordat we generatieve AI inzetten?",
    keywords: ["risicoanalyse", "verplicht", "dpia", "iama", "governance"],
    shortAnswer: "Ja, voordat een generatief AI-systeem wordt ingekocht of ontwikkeld, moet een risicoanalyse worden uitgevoerd zoals een IAMA, AIIA of een verplichte (pre-scan) DPIA bij persoonsgegevens.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=13",
    actions: [
        { text: "Wat is een DPIA?", nextId: "governance-dpia-uitleg" },
        { text: "Wat is hoog-risico AI?", nextId: "governance-hoog-risico-ai" }
    ]
  },
   {
    id: "governance-dpia-uitleg",
    question: "Wat is een DPIA?",
    keywords: ["dpia", "data protection impact assessment", "avg"],
    shortAnswer: "Een DPIA (Data Protection Impact Assessment) is een instrument om vooraf de privacyrisico's van een gegevensverwerking in kaart te brengen, zodat maatregelen genomen kunnen worden om deze risico's te verkleinen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=24",
     actions: [ {text: "Terug naar hoofdonderwerpen", nextId: "help-info"} ]
  },
  {
    id: "ambtenaar-persoonsgegevens-gebruiken",
    question: "Wat zijn de risico's van persoonsgegevens in AI?",
    keywords: ["persoonsgegevens", "avg", "privacy", "gevoelige informatie", "chatgpt", "risicos"],
    shortAnswer: "Het grootste risico is dat ingevoerde persoonsgegevens worden opgeslagen door de AI-leverancier, gebruikt voor training en onbedoeld kunnen lekken naar andere gebruikers.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    actions: [
        { text: "Hoe zit het met auteursrecht?", nextId: "ambtenaar-auteursrecht" },
        { text: "Cybersecurity risico's", nextId: "governance-cybersecurity" }
    ]
  },
  {
    id: "governance-governancestructuur-opzetten",
    question: "Hoe zetten we een effectieve AI-governance structuur op?",
    keywords: ["governance", "structuur", "beleid", "verantwoordelijkheid", "cdo"],
    shortAnswer: "Een effectieve AI-governance bestaat uit drie pijlers: een AI-strategie (beleid), een AI-stuurgroep (mensen) en een documentatiestrategie (transparantie).",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=12",
    actions: [
        { text: "Wat is een RASCI-model?", nextId: "governance-rasci" },
        { text: "Rol van het Algoritmeregister", nextId: "governance-algoritmeregister" }
    ]
  },
   {
    id: "governance-rasci",
    question: "Wat is een RASCI-model?",
    keywords: ["rasci", "verantwoordelijkheid", "rollen"],
    shortAnswer: "Een RASCI-model helpt om rollen en verantwoordelijkheden vast te leggen: wie is Responsible (verantwoordelijk), Accountable (eindverantwoordelijk), Supportive (ondersteunend), Consulted (geraadpleegd) en Informed (ge√Ønformeerd).",
     url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=21",
     actions: [ {text: "Terug naar governance", nextId: "governance-governancestructuur-opzetten"} ]
  },
    {
    id: "governance-algoritmeregister",
    question: "Wat is de rol van het Algoritmeregister?",
    keywords: ["algoritmeregister", "transparantie", "documentatie"],
    shortAnswer: "Het Algoritmeregister is een openbare publicatie waarin overheidsorganisaties de door hen ingezette algoritmes en AI-systemen documenteren om transparant te zijn over het gebruik, doel en de werking ervan.",
     url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=12",
     actions: [ {text: "Terug naar governance", nextId: "governance-governancestructuur-opzetten"} ]
  },
  {
    id: "ambtenaar-auteursrecht",
    question: "Hoe zit het met auteursrecht?",
    keywords: ["auteursrecht", "copyright", "bronvermelding", "plagiaat", "trainingsdata"],
    shortAnswer: "Wees ervan bewust dat AI-resultaten gebaseerd kunnen zijn op auteursrechtelijk beschermd materiaal. Gebruik de output daarom nooit klakkeloos, maar als startpunt. Bij twijfel, gebruik het niet.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    actions: [
        { text: "Risico's persoonsgegevens", nextId: "ambtenaar-persoonsgegevens-gebruiken" },
        { text: "Terug naar hoofdregels", nextId: "ambtenaar-regels-samenvatting" }
    ]
  },
  {
    id: "governance-bias-discriminatie",
    question: "Wat zijn de risico's op bias en discriminatie?",
    keywords: ["bias", "discriminatie", "ethiek", "vooroordelen", "eerlijkheid"],
    shortAnswer: "Het risico is dat AI-modellen discriminerende patronen uit hun trainingsdata overnemen. Dit kan leiden tot bevooroordeelde of on eerlijke resultaten.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=17",
    actions: [
        { text: "Hoe kunnen we dit voorkomen?", nextId: "governance-bias-voorkomen" }
    ]
  },
  {
    id: "governance-bias-voorkomen",
    question: "Hoe kunnen we bias en discriminatie door AI voorkomen?",
    keywords: ["bias", "discriminatie", "voorkomen", "mitigeren", "guard rails"],
    shortAnswer: "Door trainingsdata kritisch te onderzoeken, mitigerende maatregelen ('guard rails') te treffen en AI-systemen die mensenrechten raken regelmatig te testen op ongewenste bias.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=17",
    actions: [
        { text: "Wat is 'non-discriminatie by design'?", nextId: "governance-non-discriminatie-design" }
    ]
  },
    {
    id: "governance-non-discriminatie-design",
    question: "Wat is 'non-discriminatie by design'?",
    keywords: ["non-discriminatie by design", "handreiking", "ethiek"],
    shortAnswer: "Dit is een aanbevolen aanpak (en handreiking) om al tijdens het ontwerpproces van een systeem maatregelen te nemen om discriminatie te voorkomen, in plaats van het achteraf te proberen te corrigeren.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=17",
    actions: [ {text: "Terug naar Ethische Risico's", nextId: "governance-bias-discriminatie"} ]
  },
  {
    id: "ambtenaar-prompt-tips",
    question: "Heb je praktische tips voor het schrijven van prompts?",
    keywords: ["prompt", "prompting", "instructies", "tips", "effectief"],
    shortAnswer: "Jazeker. De belangrijkste tips zijn: wees specifiek, geef voldoende context, stel duidelijke regels op (zoals format en lengte) en deel complexe taken op in kleinere stappen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=22",
    actions: [
        { text: "Wat is 'chain-of-thought' prompting?", nextId: "ambtenaar-chain-of-thought" }
    ]
  },
  {
    id: "ambtenaar-chain-of-thought",
    question: "Wat is 'chain-of-thought' prompting?",
    keywords: ["chain-of-thought", "prompting", "uitlegbaarheid", "redenering"],
    shortAnswer: "Dit is een techniek waarbij je het AI-model expliciet vraagt om de beredenering van zijn antwoord stapsgewijs uit te leggen. Dit kan helpen om betere resultaten te krijgen en de output beter te controleren.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=23",
    actions: [ {text: "Terug naar prompt tips", nextId: "ambtenaar-prompt-tips"} ]
  },
  {
    id: "governance-inkoop-ai",
    question: "Waar moeten we op letten bij de inkoop van AI?",
    keywords: ["inkoop", "aanschaf", "leverancier", "vendor lock-in", "eisen"],
    shortAnswer: "Let op het voorkomen van 'vendor lock-in', geef de voorkeur aan open-source en Europese leveranciers, en zorg dat datadeling voor externe training standaard uit staat.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=13",
    actions: [ {text: "Terug naar hoofdonderwerpen", nextId: "help-info"} ]
  },
  {
    id: "ambtenaar-betrouwbaarheid-hallucineren",
    question: "Wat betekent 'hallucineren' bij AI?",
    keywords: ["betrouwbaarheid", "hallucineren", "confabuleren", "juistheid", "fouten"],
    shortAnswer: "'Hallucineren' (of 'confabuleren') is wanneer een AI-model onware informatie met grote overtuiging als een feit presenteert. Dit gebeurt omdat het model geoptimaliseerd is om plausibel te klinken, niet per se om accuraat te zijn.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=18",
    actions: [
        { text: "Hoe kan ik dit controleren?", nextId: "ambtenaar-menselijke-tussenkomst" },
        { text: "Terug naar hoofdregels", nextId: "ambtenaar-regels-samenvatting" }
    ]
  },
  {
    id: "ambtenaar-uitlegbaarheid-blackbox",
    question: "Waarom is generatieve AI een 'black box'?",
    keywords: ["black box", "uitlegbaarheid", "werking", "transparantie"],
    shortAnswer: "Het wordt een 'black box' genoemd omdat de miljarden berekeningen achter een antwoord het voor mensen onmogelijk maken om de redenering precies te volgen. Daarom mag AI alleen ondersteunend worden ingezet, niet voor directe besluitvorming.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=18",
    actions: [ {text: "Terug naar hoofdonderwerpen", nextId: "help-info"} ]
  },
  {
    id: "governance-ai-verordening",
    question: "Wat is de AI-verordening?",
    keywords: ["ai-verordening", "wetgeving", "juridisch", "risicocategorieen", "gpai"],
    shortAnswer: "De Europese AI-verordening is een uitgebreide wet die kaders en eisen vastlegt voor de ontwikkeling en het gebruik van AI. Het deelt AI-systemen in op basis van risico, met strengere regels voor hoog-risico toepassingen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    actions: [
        { text: "Wat is hoog-risico AI?", nextId: "governance-hoog-risico-ai" }
    ]
  },
    {
    id: "governance-hoog-risico-ai",
    question: "Wat is hoog-risico AI?",
    keywords: ["hoog-risico", "high risk", "ai-verordening"],
    shortAnswer: "Hoog-risico AI-toepassingen zijn door de AI-verordening gedefinieerd als systemen die een hoog risico inhouden voor de gezondheid, veiligheid of fundamentele rechten van personen. Deze moeten aan strenge verplichtingen voldoen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=24",
    actions: [ {text: "Terug naar AI-verordening", nextId: "governance-ai-verordening"} ]
  },
  {
    id: "ambtenaar-menselijke-tussenkomst",
    question: "Is menselijke controle altijd nodig?",
    keywords: ["menselijke tussenkomst", "controle", "verantwoordelijkheid", "human-in-the-loop"],
    shortAnswer: "Ja, de handreiking benadrukt dat er altijd een vorm van menselijke tussenkomst ('human-in-the-loop') ingebouwd moet zijn. De ambtenaar blijft aan het stuur en is eindverantwoordelijk.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=10",
    actions: [ {text: "Terug naar hoofdregels", nextId: "ambtenaar-regels-samenvatting"} ]
  },
  {
    id: "ambtenaar-toepassingen",
    question: "Voor welke taken kan ik AI veilig gebruiken?",
    keywords: ["toepassingen", "gebruik", "dagelijks", "taken", "kansen"],
    shortAnswer: "U kunt AI veilig inzetten voor laagdrempelige, ondersteunende taken zoals brainstormen, samenvatten, teksten versimpelen, informatie opzoeken of helpen bij het schrijven van code.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=9",
    actions: [ {text: "Terug naar 'Mag ik AI gebruiken?'", nextId: "ambtenaar-mag-ik-ai-gebruiken"} ]
  },
  {
    id: "governance-cybersecurity",
    question: "Wat zijn de cybersecurity risico's?",
    keywords: ["cybersecurity", "veiligheid", "risicos", "promptinjectie", "datalekken"],
    shortAnswer: "De belangrijkste risico's zijn datalekken (via invoer van gevoelige data), en aanvallen op het AI-model zelf, zoals 'promptinjectie' om het model te manipuleren of schadelijke output te laten produceren.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=20",
    actions: [ {text: "Terug naar hoofdonderwerpen", nextId: "help-info"} ]
  },
  {
      id: "help-info",
      question: "Help",
      shortAnswer: "U kunt mij vragen stellen over de inhoud van de handreiking, bijvoorbeeld over:\n\n‚Ä¢ Juridische kaders (AVG, AI-verordening)\n‚Ä¢ Ethische risico's (bias, transparantie)\n‚Ä¢ Praktische tips voor het gebruik van AI\n‚Ä¢ Governance en verantwoordelijkheden",
      actions: [
        { text: "Mag ik AI gebruiken?", nextId: "ambtenaar-mag-ik-ai-gebruiken" },
        { text: "Wat is een risicoanalyse?", nextId: "governance-risicoanalyse-verplicht" },
        { text: "Tips voor prompts", nextId: "ambtenaar-prompt-tips" }
      ]
  }
];

// ===================================================================================
// UI (USER INTERFACE) CODE (WITH TYPING EFFECT RESTORED)
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {
  const chatContainer = document.getElementById('chat-container');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const clearButton = document.getElementById('clear-btn');
  const helpButton = document.getElementById('help-btn');
  
  const chatbot = new EnhancedDutchEliza(websiteQA);
  
  let isTyping = false;

  function addMessage(response, isUser = false) {
    const wrapper = document.createElement('div');
    wrapper.className = isUser ? 'message-wrapper user-message-wrapper' : 'message-wrapper bot-message-wrapper';
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'user-message' : 'bot-message';
    
    wrapper.appendChild(timeDiv);
    wrapper.appendChild(messageDiv);
    
    if (isUser) {
      messageDiv.textContent = response;
      chatContainer.appendChild(wrapper);
    } else {
      chatContainer.appendChild(wrapper);
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        typeMessage(messageDiv, response, () => {
          if (response.actions && response.actions.length > 0) {
            addQuickReplies(response.actions);
          }
          enableInput();
          scrollToBottom();
        });
      }, 400 + Math.random() * 600);
    }
    scrollToBottom();
  }
  
  function typeMessage(element, response, callback) {
    const text = response.answer || response.text;
    let charIndex = 0;
    
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    element.appendChild(cursor);
    
    function type() {
      if (charIndex < text.length) {
        element.innerHTML = formatMessage(text.substring(0, charIndex + 1), response.url) + '<span class="typing-cursor"></span>';
        charIndex++;
        setTimeout(type, 20);
      } else {
        element.innerHTML = formatMessage(text, response.url); // Final render
        if (callback) callback();
      }
    }
    type();
  }

  function formatMessage(text, url) {
      let formattedText = text
          .replace(/\n/g, '<br>')
          .replace(/‚Ä¢\s/g, '<span style="color: #4285f4; font-weight: bold;">‚Ä¢</span> ');
      
      if (url) {
          formattedText += `<a href="${url}" target="_blank" class="link-card">üîó Bekijk in de handreiking (pagina ${url.split('#page=')[1]})</a>`;
      }
      return formattedText;
  }

  function showTypingIndicator() {
    if (document.getElementById('typing-indicator')) return;
    const indicator = document.createElement('div');
    indicator.id = 'typing-indicator';
    indicator.className = 'typing-indicator';
    indicator.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
    chatContainer.appendChild(indicator);
    scrollToBottom();
  }

  function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
  }

  function addQuickReplies(actions) {
    removeExistingQuickReplies();
    const container = document.createElement('div');
    container.className = 'quick-replies';
    
    actions.forEach(action => {
      const button = document.createElement('button');
      button.className = 'quick-reply-btn';
      button.textContent = action.text;
      button.onclick = () => handleQuickReply(action.text);
      container.appendChild(button);
    });
    chatContainer.appendChild(container);
    scrollToBottom();
  }

  function removeExistingQuickReplies() {
    const existing = chatContainer.querySelector('.quick-replies');
    if (existing) existing.remove();
  }

  function handleQuickReply(text) {
    addMessage(text, true);
    removeExistingQuickReplies();
    disableInput();
    const response = chatbot.generateResponse(text);
    addMessage(response);
  }

  function handleUserInput() {
    const text = userInput.value.trim();
    if (!text || isTyping) return;
    addMessage(text, true);
    userInput.value = '';
    removeExistingQuickReplies();
    disableInput();
    const response = chatbot.generateResponse(text);
    addMessage(response);
  }

  function disableInput() {
    isTyping = true;
    userInput.disabled = true;
    sendButton.disabled = true;
  }

  function enableInput() {
    isTyping = false;
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.focus();
  }
  
  function scrollToBottom() {
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
  }

  function clearConversation() {
    if (confirm('Weet u zeker dat u het gesprek wilt wissen?')) {
      chatContainer.innerHTML = '';
      chatbot.clearSession();
      const welcomeResponse = chatbot.generateResponse("hallo");
      addMessage(welcomeResponse);
    }
  }

  // Event Listeners
  sendButton.addEventListener('click', handleUserInput);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleUserInput();
    }
  });
  clearButton.addEventListener('click', clearConversation);
  helpButton.addEventListener('click', () => {
      const helpResponse = chatbot.getHelpInfo();
      addMessage(helpResponse);
  });

  // Initial greeting
  const welcomeResponse = chatbot.generateResponse("hallo");
  addMessage(welcomeResponse);
});

function emailConversation() {
  const supportEmail = 'support@voorbeeld.nl'; // <-- CHANGE THIS
  const pageTitle = document.title;
  const currentDate = new Date().toLocaleDateString('nl-NL', { dateStyle: 'long' });
  const subject = `Chat Transcript: ${pageTitle} - ${currentDate}`;
  
  const messages = document.querySelectorAll('#chat-container .message-wrapper');
  if (messages.length === 0) {
    alert("Er is nog geen gesprek om te mailen.");
    return;
  }
  
  const transcript = Array.from(messages).map(wrapper => {
    const time = wrapper.querySelector('.message-time').textContent;
    const sender = wrapper.classList.contains('user-message-wrapper') ? 'U' : 'Assistent';
    const text = wrapper.querySelector('.user-message, .bot-message').textContent;
    return `[${time}] ${sender}: ${text}`;
  }).join('\n');
  
  const body = `Hieronder staat het transcript van mijn gesprek met de virtuele assistent:\n\n--------------------------------------------------\n${transcript}\n--------------------------------------------------\n\nMijn onbeantwoorde vraag is:\n\n`;
  const mailtoLink = `mailto:${supportEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoLink;
}
</script>

</body>
</html>
