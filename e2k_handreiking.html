<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wegwijzer AI Handreiking</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    #chat-window {
      width: 100%;
      max-width: 600px;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      background: white;
    }

    #chat-header {
      background: linear-gradient(135deg, #0078d7 0%, #005a9f 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chat-title {
      font-size: 1.3em;
      font-weight: 600;
    }

    #chat-controls {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background-color: #fafafa;
      scroll-behavior: smooth;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      margin: 8px 0;
    }

    .message-time {
      font-size: 0.75em;
      color: #666;
      margin: 2px 0;
    }

    .user-message-wrapper { align-items: flex-end; }
    .user-message-wrapper .message-time { text-align: right; }
    .bot-message-wrapper { align-items: flex-start; }

    .user-message, .bot-message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 85%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user-message {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      align-self: flex-end;
    }

    .bot-message {
      background: white;
      color: #333;
      align-self: flex-start;
      border: 1px solid #e1e5e9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .typing-indicator {
      background: white;
      border: 1px solid #e1e5e9;
      padding: 16px;
      border-radius: 18px;
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .typing-dots { display: flex; gap: 4px; }
    .typing-dot {
      width: 6px; height: 6px; background: #666; border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }

    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-self: flex-start;
      max-width: 100%;
    }

    .quick-reply-btn {
      background: #f1f3f4;
      border: 1px solid #dadce0;
      color: #3c4043;
      padding: 8px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }

    .quick-reply-btn:hover {
      background: #e8f0fe;
      border-color: #4285f4;
      color: #1a73e8;
    }
    
    #input-area {
      display: flex; padding: 16px; border-top: 1px solid #e1e5e9;
      background-color: white; gap: 10px;
    }

    #user-input {
      flex-grow: 1; padding: 12px 16px; border: 2px solid #e1e5e9;
      border-radius: 24px; outline: none; font-size: 16px; transition: border-color 0.2s;
    }
    #user-input:focus { border-color: #4285f4; }

    #send-button {
      padding: 12px 20px; background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
      color: white; border: none; border-radius: 24px;
      cursor: pointer; font-weight: 600; transition: all 0.2s; min-width: 80px;
    }
    #send-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }
    #send-button:disabled {
      background: #dadce0; cursor: not-allowed;
      transform: none; box-shadow: none;
    }
    a.link-card {
        display: block; background: #f8f9fa; border: 1px solid #dadce0; border-radius: 8px;
        padding: 12px; margin-top: 8px; text-decoration: none; color: #1a73e8; transition: all 0.2s;
    }
    a.link-card:hover {
        background: #e8f0fe; border-color: #a3c5fb;
    }
  </style>
</head>
<body>

  <div id="chat-window" role="main">
    <div id="chat-header">
      <div id="chat-title">Wegwijzer AI Handreiking</div>
      <div id="chat-controls">
        <button class="control-btn" id="clear-btn" title="Gesprek wissen">üóëÔ∏è Wissen</button>
        <button class="control-btn" id="help-btn" title="Help">‚ùì Help</button>
        <button class="control-btn" id="email-btn" onclick="emailConversation()" title="Mail dit gesprek naar een medewerker">üìß Mail een medewerker</button>
      </div>
    </div>
    <div id="chat-container" role="log" aria-live="polite" aria-label="Chat berichten"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="Typ uw vraag hier..." autocomplete="off">
      <button id="send-button" aria-label="Bericht verzenden">Stuur</button>
    </div>
  </div>

<script>
// ===================================================================================
// CHATBOT LOGIC
// ===================================================================================

class EnhancedDutchEliza {
  constructor(qaData) {
    this.qaData = qaData;
    this.qaDataMap = new Map(qaData.map(item => [item.id, item]));
    this.conversationState = {
        currentTopic: null,
        activeFollowUpActions: [],
    };

    this.patterns = [
      { 
        regex: /^(hallo|hoi|hey|goedemorgen|goedemiddag|goedenavond)!?$/i, 
        responses: ["Hallo! Ik ben de Wegwijzer voor de Overheidsbrede handreiking Generatieve AI. Hoe kan ik u helpen?"], 
        quickReplies: ["Mag ik AI gebruiken?", "Wat is het doel van de handreiking?", "Tips voor prompts"] 
      },
      { 
        regex: /bedankt|dank(je)?( wel)?/i, 
        responses: ["Graag gedaan! Heeft u nog andere vragen?"],
        quickReplies: ["Juridische aspecten", "Ethische risico's", "Praktische tips"]
      },
      { 
        regex: /doei|tot ziens|dag/i, 
        responses: ["Tot ziens! Kom gerust terug als u meer vragen heeft."] 
      },
      { 
        regex: /help|hulp/i, 
        isHelpRequest: true 
      },
      // Fallback for simple "ja" when no specific follow-up is active
      { 
        regex: /^ja|zeker|graag$/i,
        responses: ["Ok√©, waarover wilt u meer weten?"],
        quickReplies: ["Juridische aspecten", "Ethische risico's", "Praktische tips"]
      },
      { 
        regex: /^nee$/i, 
        responses: ["Prima! Waarmee kan ik u dan wel helpen?"],
        quickReplies: ["Juridische aspecten", "Ethische risico's", "Praktische tips"]
      },
    ];

    this.fallbackResponses = [
      "Dat is een interessante vraag. Ik zal kijken wat ik kan vinden in de handreiking. Kunt u het iets specifieker formuleren?",
      "Ik begrijp de vraag niet helemaal in de context van de handreiking. Kunt u het anders stellen?",
      "Ik kan daar geen direct antwoord op vinden. Misschien is uw vraag gerelateerd aan een van deze hoofdonderwerpen?"
    ];
  }

  // Find a direct answer from the Q&A data using fuzzy keyword matching
  findRelevantQA(userInput) {
    const userKeywords = this.extractKeywords(userInput);
    if (userKeywords.length === 0) return null;

    let bestMatch = { score: 0, item: null };

    for (const item of this.qaData) {
      const itemKeywords = [...this.extractKeywords(item.question), ...(item.keywords || [])];
      let score = 0;
      userKeywords.forEach(userWord => {
        itemKeywords.forEach(itemWord => {
          if (userWord === itemWord) score += 2; // Exact match
          else if (itemWord.includes(userWord)) score += 1; // Partial match
        });
      });
      
      const confidence = score / (userKeywords.length + itemKeywords.length);
      
      if (confidence > bestMatch.score && confidence > 0.35) {
        bestMatch = { score: confidence, item: item };
      }
    }
    return bestMatch.item;
  }
  
  extractKeywords(text) {
    const commonWords = ['de','het','een','en','van','in','op','aan','met','voor','door','is','zijn','was','ik','je','u','hij','zij','wij','jullie','hoe','wat','waar','wie','waarom','welke','of','dat','dit'];
    return text.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(word => word.length > 2 && !commonWords.includes(word));
  }

  // The main function to get a response
  generateResponse(userInput) {
    // 1. Check if the input matches an active follow-up action (from a button)
    const contextualAction = this.conversationState.activeFollowUpActions.find(
      action => action.text.toLowerCase() === userInput.toLowerCase()
    );
    if (contextualAction && contextualAction.nextId) {
      const nextItem = this.qaDataMap.get(contextualAction.nextId);
      if (nextItem) {
        this.conversationState.currentTopic = nextItem;
        this.conversationState.activeFollowUpActions = nextItem.followUpActions || [];
        return { ...nextItem, answer: nextItem.shortAnswer };
      }
    }
    
    // 2. Reset context and check for standard patterns (hallo, bedankt, etc.)
    this.conversationState.activeFollowUpActions = [];
    for (const pattern of this.patterns) {
      if (pattern.regex.test(userInput)) {
        if (pattern.isHelpRequest) return this.getHelpInfo();
        return { text: this.randomChoice(pattern.responses), quickReplies: pattern.quickReplies };
      }
    }

    // 3. If no pattern matches, search the main Q&A database
    const qaItem = this.findRelevantQA(userInput);
    if (qaItem) {
        this.conversationState.currentTopic = qaItem;
        this.conversationState.activeFollowUpActions = qaItem.followUpActions || [];
        return { ...qaItem, answer: qaItem.shortAnswer };
    }

    // 4. If nothing is found, provide a helpful fallback
    return { 
        text: this.randomChoice(this.fallbackResponses),
        quickReplies: ["Juridische aspecten", "Ethische risico's", "Praktische tips"]
    };
  }

  getHelpInfo() {
    return {
      text: `Ik ben uw Wegwijzer voor de AI Handreiking. U kunt mij vragen stellen over de inhoud, bijvoorbeeld over:\n\n‚Ä¢ Juridische kaders (AVG, AI-verordening)\n‚Ä¢ Ethische risico's (bias, transparantie)\n‚Ä¢ Praktische tips voor het gebruik van AI\n‚Ä¢ Governance en verantwoordelijkheden`,
      quickReplies: ["Mag ik AI gebruiken?", "Wat is een risicoanalyse?", "Tips voor prompts"]
    };
  }
  
  randomChoice(array) {
    return array[Math.floor(Math.random() * array.length)];
  }

  clearSession() {
      this.conversationState = { currentTopic: null, activeFollowUpActions: [] };
  }
}

// ===================================================================================
// Q&A DATASET: OVERHEIDSBREDE HANDREIKING GENERATIEVE AI
// ===================================================================================

const websiteQA = [
  {
    id: "ambtenaar-mag-ik-ai-gebruiken",
    question: "Mag ik generatieve AI gebruiken voor mijn werk?",
    keywords: ["mag", "gebruiken", "toegestaan", "inzetten", "ai", "chatgpt", "werk"],
    shortAnswer: "Ja, u mag generatieve AI gebruiken als hulpmiddel voor taken met een laag risico, mits u geen gevoelige of persoonsgegevens invoert en er altijd menselijke controle is.",
    followUp: "Wilt u weten voor welke specifieke taken AI geschikt is, of wat de belangrijkste regels zijn?",
    followUpActions: [
        { text: "Geschikte taken", nextId: "ambtenaar-toepassingen" },
        { text: "Belangrijkste regels", nextId: "ambtenaar-regels-samenvatting" }
    ]
  },
  {
    id: "ambtenaar-regels-samenvatting",
    question: "Wat zijn de belangrijkste regels bij het gebruik van AI?",
    keywords: ["regels", "samenvatting", "belangrijkste", "voorwaarden"],
    shortAnswer: "De drie belangrijkste regels zijn: 1. Voer nooit persoonsgegevens of gevoelige informatie in. 2. Neem de output nooit klakkeloos over (menselijke controle). 3. Wees bewust van auteursrecht en de betrouwbaarheid van de output.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=22",
    quickReplies: ["Risico's persoonsgegevens", "Betrouwbaarheid (hallucineren)", "Auteursrecht uitgelegd"]
  },
  {
    id: "ambtenaar-scope-handreiking",
    question: "Wat is het doel van deze handreiking voor mij als ambtenaar?",
    keywords: ["doel", "scope", "handreiking", "document", "waarom"],
    shortAnswer: "De handreiking geeft u als ambtenaar direct inzetbare handvatten om generatieve AI op een verantwoorde manier te gebruiken in uw werk.",
    followUp: "Wilt u weten of de handreiking bindend is of welke onderwerpen het precies behandelt?",
    followUpActions: [
        { text: "Is het bindend?", nextId: "ambtenaar-handreiking-bindend" },
        { text: "Welke onderwerpen?", nextId: "ambtenaar-handreiking-onderwerpen" }
    ]
  },
  {
    id: "ambtenaar-handreiking-bindend",
    question: "Is de handreiking bindend?",
    keywords: ["bindend", "verplicht", "regels", "wet"],
    shortAnswer: "Nee, het document is niet-bindend en legt geen nieuwe verplichtingen op. Het is bedoeld als een direct bruikbaar hulpmiddel en praktische gids.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=5",
    quickReplies: ["Doel van de handreiking", "Juridische aspecten", "AI-verordening"]
  },
  {
    id: "ambtenaar-handreiking-onderwerpen",
    question: "Welke onderwerpen behandelt de handreiking?",
    keywords: ["onderwerpen", "inhoud", "hoofdstukken"],
    shortAnswer: "De handreiking behandelt de technologische, organisatorische, ethische en juridische voorwaarden voor de verantwoorde inzet van generatieve AI, van experiment tot toepassing.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=5",
    quickReplies: ["Juridische aspecten", "Ethische risico's", "Governance"]
  },
  {
    id: "governance-risicoanalyse-verplicht",
    question: "Is het uitvoeren van een risicoanalyse verplicht voordat we generatieve AI inzetten?",
    keywords: ["risicoanalyse", "verplicht", "dpia", "iama", "governance"],
    shortAnswer: "Ja, voordat een generatief AI-systeem wordt ingekocht of ontwikkeld, moet een risicoanalyse worden uitgevoerd.",
    followUp: "Wilt u weten welke soorten risicoanalyses er zijn en wanneer ze nodig zijn?",
    fullAnswer: "De handreiking noemt verschillende instrumenten uit het Algoritmekader, zoals een Impact Assessment Mensenrechten en Algoritmen (IAMA) of een AI Impact Assessment (AIIA). Het doel is om een interdisciplinaire discussie over de risico's te starten.",
    moreInfo: "Een Data Protection Impact Assessment (DPIA) is specifiek vereist als de AVG dat voorschrijft. Een pre-scan DPIA is echter √°ltijd verplicht als er persoonsgegevens worden verwerkt. De uitkomsten van deze assessments moeten bestuurlijk worden gemaakt.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=13",
    quickReplies: ["Wat is een DPIA?", "Hoog-risico AI", "Algoritmekader"]
  },
  {
    id: "ambtenaar-persoonsgegevens-gebruiken",
    question: "Mag ik persoonsgegevens invoeren in een publieke AI-tool zoals ChatGPT?",
    keywords: ["persoonsgegevens", "avg", "privacy", "gevoelige informatie", "chatgpt"],
    shortAnswer: "Nee, het is volgens de privacywetgeving (zoals de AVG) onrechtmatig om zonder wettelijke grondslag persoonsgegevens in een generatief AI-systeem in te voeren.",
    followUp: "Wilt u meer weten over de risico's van het delen van data met AI-modellen?",
    fullAnswer: "Het risico is dat de ingevoerde informatie, inclusief persoonsgegevens, kan worden opgeslagen door de ontwikkelaars van het model. Deze data kan dan worden gebruikt voor trainingsdoeleinden en kan onbedoeld terugkomen in de uitkomsten voor andere gebruikers, wat tot datalekken kan leiden.",
    moreInfo: "Dit geldt standaard bij niet-gecontracteerde diensten. Zelfs bij ingekochte software is het cruciaal om duidelijke afspraken te maken met leveranciers over datagebruik en -opslag. Overweeg ook om de instellingen voor datadeling voor modeloptimalisatie uit te schakelen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    quickReplies: ["Auteursrecht", "Veiligheidsaspecten", "Tips voor prompts"]
  },
  {
    id: "governance-governancestructuur-opzetten",
    question: "Hoe zetten we een effectieve AI-governance structuur op binnen onze organisatie?",
    keywords: ["governance", "structuur", "beleid", "verantwoordelijkheid", "cdo"],
    shortAnswer: "Een effectieve AI-governance helpt bij de implementatie en het beheersen van risico's en bestaat uit een AI-strategie, een stuurgroep en een documentatiestrategie.",
    followUp: "Wilt u de concrete onderdelen van een goede AI-governance structuur zien?",
    fullAnswer: "Een goede structuur omvat de volgende onderdelen:\n‚Ä¢ **AI-strategie of beleid:** Vertaal deze handreiking naar een interne versie en laat deze reviewen door o.a. de CPO, CDO, CISO en CIO.\n‚Ä¢ **AI-stuurgroep en verantwoording:** Wijs eindverantwoordelijken toe voor o.a. privacy en cybersecurity in relatie tot AI.\n‚Ä¢ **Documentatiestrategie:** Wees transparant over het gebruik van AI, bij voorkeur via het Algoritmeregister.",
    moreInfo: "Zorg binnen uw beleid ook voor een 'fall back' scenario voor als de AI niet meer ingezet kan worden. Wijs burgers er expliciet op als ze met een AI interacteren en bied altijd een optie om met een mens te spreken. Gebruik een RASCI-model om rollen en verantwoordelijkheden helder te beleggen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=12",
    quickReplies: ["Wat is een RASCI-model?", "Algoritmeregister", "Verantwoordelijkheid"]
  },
  {
    id: "ambtenaar-auteursrecht",
    question: "Hoe moet ik omgaan met auteursrecht als ik AI-gegenereerde tekst gebruik?",
    keywords: ["auteursrecht", "copyright", "bronvermelding", "plagiaat", "trainingsdata"],
    shortAnswer: "Wees ervan bewust dat AI-resultaten gebaseerd kunnen zijn op auteursrechtelijk beschermd materiaal, omdat de trainingsdata dit vaak bevatten.",
    followUp: "Wilt u weten wat u concreet moet doen om risico's te vermijden?",
    fullAnswer: "Neem de door AI gegenereerde resultaten nooit klakkeloos over, maar gebruik ze als startpunt of ter ondersteuning. Als u vermoedt dat er inbreuk wordt gemaakt op auteursrecht, gebruik de uitkomsten dan niet. Bij twijfel is het raadzaam contact op te nemen met een specialist.",
    moreInfo: "De AI-verordening zal aanbieders van grote AI-modellen verplichten om transparanter te zijn over hun trainingsdata. Dit moet rechthebbenden helpen controleren of de regels voor tekst- en datamining worden nageleefd. De output van een AI mag sowieso niet te veel lijken op een specifiek werk waarmee het getraind is.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    quickReplies: ["Privacy (AVG)", "Betrouwbaarheid output", "Mag ik AI gebruiken?"]
  },
  {
    id: "governance-bias-discriminatie",
    question: "Hoe voorkomen we dat onze inzet van generatieve AI leidt tot bias en discriminatie?",
    keywords: ["bias", "discriminatie", "ethiek", "vooroordelen", "eerlijkheid"],
    shortAnswer: "Bias kan ontstaan doordat discriminerende patronen uit de trainingsdata worden overgenomen. Het is essentieel om data kritisch te onderzoeken en mitigerende maatregelen ('guard rails') te treffen.",
    followUp: "Wilt u weten welke concrete stappen we als organisatie moeten nemen?",
    fullAnswer: "Organisaties wordt aangeraden goed na te gaan welke anti-discriminatie-eisen ze stellen. Resultaten van AI-systemen die mensenrechten raken, moeten tijdig en regelmatig worden getest op ongewenste bias, zowel tijdens de ontwikkeling als na ingebruikname. Overweeg ook de handreiking 'non-discriminatie by design' te raadplegen.",
    moreInfo: "Stel een protocol op voor als er toch discriminatie optreedt. Het is belangrijk te onderzoeken wat de risico's zijn als een model niet aan de anti-discriminatie-eisen kan voldoen. Wees ook bedacht op 'groepsdenken', waarbij een model tot een consensus kan komen zonder alternatieve zienswijzen te overwegen.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=17",
    quickReplies: ["Ethische aspecten", "Transparantie", "AI-verordening"]
  },
  {
    id: "ambtenaar-prompt-tips",
    question: "Heb je tips voor het schrijven van goede en veilige prompts?",
    keywords: ["prompt", "prompting", "instructies", "tips", "effectief"],
    shortAnswer: "Ja, wees specifiek, geef context, stel regels op en experimenteer met verschillende instructies om de beste en meest betrouwbare resultaten te krijgen.",
    followUp: "Wilt u een overzicht van concrete tips voor effectieve prompts?",
    fullAnswer: "Hier zijn enkele belangrijke tips:\n‚Ä¢ **Wees specifiek:** Gebruik duidelijke taal en genoeg details. Deel een complexe taak op in simpelere subtaken.\n‚Ä¢ **Geef context:** Modellen kennen standaard geen context. Geef dus achtergrondinformatie, het doel en de doelgroep mee.\n‚Ä¢ **Stel regels:** Geef aan hoe lang het antwoord moet zijn, en in welke stijl of format (bijv. tabel, lijst, stappenplan).",
    moreInfo: "Wees voorzichtig met suggestieve vragen, omdat de AI dan waarschijnlijk een bevestigend antwoord geeft. Om de uitlegbaarheid te vergroten, kun je 'chain-of-thought prompting' toepassen, waarbij je het model vraagt om zijn beredenering stapsgewijs uit te leggen. Overweeg een training te volgen, bijvoorbeeld bij RADIO.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=22",
    quickReplies: ["Wat is 'chain-of-thought'?", "Mag ik gevoelige info gebruiken?", "Betrouwbaarheid van AI"]
  },
  {
    id: "governance-inkoop-ai",
    question: "Waar moeten we op letten bij de inkoop van generatieve AI-toepassingen?",
    keywords: ["inkoop", "aanschaf", "leverancier", "vendor lock-in", "eisen"],
    shortAnswer: "Betrek commerci√´le collega's vanaf het begin, besteed aandacht aan leveranciersmanagement en stel duidelijke requirements op over o.a. datagebruik en monitoring.",
    followUp: "Wilt u een checklist met belangrijke aandachtspunten voor het inkoopproces?",
    fullAnswer: "Belangrijke aandachtspunten zijn:\n‚Ä¢ **Voorkom vendor lock-in:** Overweeg alle mogelijkheden en verken lokale of Europese dienstverleners.\n‚Ä¢ **Nederlandse taal:** Controleer hoe goed het model omgaat met de Nederlandse taal, eventueel met benchmarks zoals OpengGPT-X.\n‚Ä¢ **Voorkeur voor open-source:** Gebruik bij voorkeur een open-source applicatie voor meer transparantie, zolang dit niet ten koste gaat van de veiligheid.\n‚Ä¢ **Data-instellingen:** Zorg dat datadeling voor externe modeloptimalisatie standaard uit staat.",
    moreInfo: "Leer van andere overheidsorganisaties die al AI hebben ge√Ømplementeerd. Voor hoog-risico toepassingen zal de opdrachtgever een actievere rol moeten spelen in de samenwerking met de leverancier, bijvoorbeeld door juridische en ethische grenzen aan te geven.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=13",
    quickReplies: ["Open vs Closed source", "Europese soevereiniteit", "Hoog-risico AI"]
  },
  {
    id: "ambtenaar-betrouwbaarheid-hallucineren",
    question: "Is de output van een generatieve AI altijd feitelijk juist?",
    keywords: ["betrouwbaarheid", "hallucineren", "confabuleren", "juistheid", "fouten"],
    shortAnswer: "Nee, generatieve AI-modellen geven niet altijd een feitelijk juist antwoord en kunnen onware informatie als feit presenteren (dit heet 'hallucineren').",
    followUp: "Wilt u weten waarom dit gebeurt en hoe u de kwaliteit kunt beoordelen?",
    fullAnswer: "Dit gebeurt omdat generatieve AI is geoptimaliseerd voor plausibiliteit (wat klinkt logisch), niet voor nauwkeurigheid. De kwaliteit van de output wordt sterk be√Ønvloed door de kwaliteit van de trainingsdata en de kwaliteit van uw prompt. De data kan bijvoorbeeld incompleet of verouderd zijn.",
    moreInfo: "Het is essentieel om de uitkomsten altijd kritisch te beoordelen en niet √©√©n-op-√©√©n over te nemen. Formuleer eerst uw eigen antwoord voordat u de AI gebruikt. Voor de overheid is dit extra belangrijk, omdat het verstrekken van onbetrouwbare informatie de geloofwaardigheid en reputatie kan schaden.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=18",
    quickReplies: ["Tips voor prompts", "Ethische aspecten", "Uitlegbaarheid (black box)"]
  },
  {
    id: "governance-transparantie-algoritmeregister",
    question: "Hoe zorgen we als organisatie voor transparantie over ons gebruik van generatieve AI?",
    keywords: ["transparantie", "algoritmeregister", "documentatie", "openheid", "verantwoording"],
    shortAnswer: "Wees transparant door het gebruik van generatieve AI-toepassingen te documenteren en te publiceren, bij voorkeur via het Algoritmeregister.",
    followUp: "Wilt u weten welke informatie we precies moeten documenteren?",
    fullAnswer: "De documentatie moet gedetailleerd zijn, bijvoorbeeld volgens de Publicatiestandaard. Beschrijf in ieder geval het publieke doel, de doelgroep en of de interactie intern of extern is. Documenteer ook overwegingen over datagebruik, bijvoorbeeld of het model verder getraind zal worden en met welke data.",
    moreInfo: "Zorg dat uitgevoerde risicoanalyses zoals DPIA's en IAMA's centraal worden verzameld, zodat ze makkelijk terug te vinden zijn en dubbel werk wordt voorkomen. Als AI invloed heeft op besluitvorming, moeten personen van wie de data wordt verwerkt of die met de AI interacteren hiervan op de hoogte worden gesteld.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=17",
    quickReplies: ["Wat is een DPIA?", "Ethische aspecten", "Uitlegbaarheid"]
  },
  {
    id: "ambtenaar-uitlegbaarheid-blackbox",
    question: "Waarom wordt gezegd dat generatieve AI een 'black box' is?",
    keywords: ["black box", "uitlegbaarheid", "werking", "beslisboom", "transparantie"],
    shortAnswer: "Generatieve AI-modellen worden 'black box' genoemd omdat de uitkomsten niet goed beredeneerd kunnen worden, in tegenstelling tot een eenvoudig algoritme zoals een beslisboom.",
    followUp: "Wilt u weten wat dit betekent voor de inzet bij de overheid?",
    fullAnswer: "De miljarden calculaties die voor elke output nodig zijn, maken het voor een mens onmogelijk om de werking op het laagste niveau te begrijpen. Dit is een van de hoofdredenen waarom generatieve AI niet voor directe besluitvorming mag worden ingezet, maar alleen ter ondersteuning.",
    moreInfo: "Om toch een vorm van uitleg te geven, kan men informatie verschaffen over de capaciteiten, beperkingen en trainingsdata van het model. Dit helpt gebruikers te begrijpen wat het model wel en niet goed kan. Het is altijd verstandig om als organisatie na te gaan of een 'black box'-model de beste keuze is, of dat een simpeler, uitlegbaar algoritme dezelfde oplossing kan bieden.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=18",
    quickReplies: ["Betrouwbaarheid AI", "Menselijke tussenkomst", "AI voor besluitvorming"]
  },
  {
    id: "governance-ai-verordening",
    question: "Wat zijn de belangrijkste implicaties van de Europese AI-verordening voor onze organisatie?",
    keywords: ["ai-verordening", "wetgeving", "juridisch", "risicocategorieen", "gpai"],
    shortAnswer: "De AI-verordening is een belangrijk wettelijk kader dat AI-systemen indeelt in risicocategorie√´n, met zwaardere regels voor hogere risico's.",
    followUp: "Wilt u weten hoe dit generatieve AI en onze rol als overheidspartij be√Ønvloedt?",
    fullAnswer: "Generatieve AI valt onder 'general purpose AI' (GPAI) in de verordening en heeft specifieke eisen. Als wij een GPAI-model inkopen en inzetten voor een domein-specifieke toepassing, is het cruciaal om vast te stellen of we dan 'aanbieder' of 'gebruiksverantwoordelijke' zijn. Dit bepaalt namelijk aan welke vereisten we moeten voldoen.",
    moreInfo: "Met name de inzet van hoog-risico toepassingen vereist extra afwegingen en naleving van strenge regels. De verordening treedt gefaseerd in werking. Deze handreiking is bedoeld om de periode te overbruggen waarin de verordening nog niet volledig van kracht is.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=15",
    quickReplies: ["Hoog-risico AI", "Juridische aspecten", "Inkoop van AI"]
  },
  {
    id: "ambtenaar-menselijke-tussenkomst",
    question: "Moet er altijd een mens meekijken bij het gebruik van generatieve AI?",
    keywords: ["menselijke tussenkomst", "controle", "verantwoordelijkheid", "ambtenaar", "human-in-the-loop"],
    shortAnswer: "Ja, het is van belang om bij de inzet van generatieve AI altijd een vorm van menselijke tussenkomst in te bouwen.",
    followUp: "Wilt u weten waarom dit zo belangrijk is?",
    fullAnswer: "Het inbouwen van menselijke tussenkomst, ook wel 'human-in-the-loop' genoemd, zorgt ervoor dat de ambtenaar aan het stuur blijft bij de inzet van generatieve AI. Dit draagt bij aan de betrouwbaarheid van de output en zorgt ervoor dat de uiteindelijke verantwoordelijkheid bij een mens ligt.",
    moreInfo: "U moet AI slechts als hulpmiddel gebruiken, niet als vervanging voor uw eigen vaardigheden of oordeel. Neem gegenereerde content nooit √©√©n-op-√©√©n over en formuleer altijd eerst uw eigen antwoord. Dit is vooral cruciaal omdat AI niet geschikt is voor directe besluitvorming.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=10",
    quickReplies: ["Uitlegbaarheid (black box)", "Betrouwbaarheid AI", "AI voor besluitvorming"]
  },
  {
    id: "governance-duurzaamheid",
    question: "Wat is de milieu-impact van generatieve AI en hoe kunnen we dit als organisatie beperken?",
    keywords: ["duurzaamheid", "milieu", "energieverbruik", "co2", "waterverbruik"],
    shortAnswer: "Het trainen en gebruiken van generatieve AI vereist veel rekenkracht, wat impact heeft op het klimaat door energie-, water- en grondstofverbruik.",
    followUp: "Wilt u weten welke concrete stappen we kunnen nemen om duurzamer met AI om te gaan?",
    fullAnswer: "Organisaties wordt aangeraden om na te gaan waarom specifiek voor een generatief AI-model wordt gekozen en of een duurzamer alternatief dezelfde oplossing kan bieden. Daarnaast kan een duurzaamheidsimpactanalyse worden uitgevoerd om de uitstoot zo laag mogelijk te houden.",
    moreInfo: "Concrete maatregelen zijn bijvoorbeeld het gebruiken van bestaande, voorgetrainde systemen en deze enkel te finetunen, of de voorkeur te geven aan energie-effici√´nte dataservers. Helaas bestaan er nog geen gestandaardiseerde methodes om de milieu-impact precies te meten en zijn veel dienstverleners hier niet transparant over.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=18",
    quickReplies: ["Ethische aspecten", "Inkoop van AI", "Keuze voor AI"]
  },
  {
    id: "ambtenaar-toepassingen",
    question: "Voor welke dagelijkse taken kan ik generatieve AI nuttig en veilig inzetten?",
    keywords: ["toepassingen", "gebruik", "dagelijks", "taken", "kansen"],
    shortAnswer: "Generatieve AI kan veilig worden ingezet voor laagdrempelige taken met een lage impact, zoals het genereren van idee√´n, vinden van informatie en tekstbewerking.",
    followUp: "Wilt u een lijst met voorbeelden van veilige toepassingsgebieden?",
    fullAnswer: "Veilige toepassingen zijn onder andere:\n‚Ä¢ **Nieuwe idee√´n genereren:** Helpen bij brainstorms en het aandragen van nieuwe zienswijzen.\n‚Ä¢ **Informatie vinden:** Snel publieke of interne informatie lokaliseren.\n‚Ä¢ **Tekstbewerking:** Teksten vertalen, versimpelen, of herschrijven voor verschillende doelgroepen.\n‚Ä¢ **Softwareontwikkeling:** Helpen bij het schrijven en controleren van code.",
    moreInfo: "Andere voorbeelden zijn het ondersteunen van beleidsmedewerkers door antwoorden uit complexe beleidsinformatie te halen, het maken van samenvattingen, of het opstellen van concept-FAQ's bij een document. Voor toepassingen die ingrijpen in het primaire proces of gevoelige data gebruiken, zijn risicoanalyses essentieel.",
    url: "https://open.overheid.nl/documenten/9c273b71-cebb-4e11-b06f-fa20f7b4b90e/file#page=9",
    quickReplies: ["Risicoanalyses", "Idee√´n genereren", "Software code schrijven"]
  }
];

// ===================================================================================
// UI (USER INTERFACE) CODE
// ===================================================================================

document.addEventListener('DOMContentLoaded', () => {
  const chatContainer = document.getElementById('chat-container');
  const userInput = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const clearButton = document.getElementById('clear-btn');
  const helpButton = document.getElementById('help-btn');
  
  const chatbot = new EnhancedDutchEliza(websiteQA);
  
  let isTyping = false;

  function addMessage(response, isUser = false) {
    const wrapper = document.createElement('div');
    wrapper.className = isUser ? 'message-wrapper user-message-wrapper' : 'message-wrapper bot-message-wrapper';
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'user-message' : 'bot-message';
    
    wrapper.appendChild(timeDiv);
    wrapper.appendChild(messageDiv);
    
    if (isUser) {
      messageDiv.textContent = response;
      chatContainer.appendChild(wrapper);
    } else {
      chatContainer.appendChild(wrapper);
      showTypingIndicator();
      setTimeout(() => {
        hideTypingIndicator();
        messageDiv.innerHTML = formatMessage(response.answer || response.text);
        if (response.followUpActions && response.followUpActions.length > 0) {
            addQuickReplies(response.followUpActions, true);
        } else if (response.quickReplies && response.quickReplies.length > 0) {
            addQuickReplies(response.quickReplies, false);
        }
        enableInput();
        scrollToBottom();
      }, 500 + Math.random() * 500);
    }
    scrollToBottom();
  }

  function formatMessage(text) {
      const formattedText = text
          .replace(/\n/g, '<br>')
          .replace(/‚Ä¢\s/g, '<span style="color: #4285f4; font-weight: bold;">‚Ä¢</span> ');

      const urlRegex = /(https?:\/\/[^\s]+#page=\d+)/g;
      if (text.match(urlRegex)) {
          const url = text.match(urlRegex)[0];
          return formattedText.replace(url, `<a href="${url}" target="_blank" class="link-card">üîó Bekijk in de handreiking (pagina ${url.split('#page=')[1]})</a>`);
      }
      return formattedText;
  }

  function showTypingIndicator() {
    if (document.getElementById('typing-indicator')) return;
    const indicator = document.createElement('div');
    indicator.id = 'typing-indicator';
    indicator.className = 'typing-indicator';
    indicator.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
    chatContainer.appendChild(indicator);
    scrollToBottom();
  }

  function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
  }

  function addQuickReplies(replies, isFollowUpAction) {
    removeExistingQuickReplies();
    const container = document.createElement('div');
    container.className = 'quick-replies';
    
    replies.forEach(reply => {
      const button = document.createElement('button');
      button.className = 'quick-reply-btn';
      button.textContent = isFollowUpAction ? reply.text : reply;
      button.onclick = () => handleQuickReply(button.textContent);
      container.appendChild(button);
    });
    chatContainer.appendChild(container);
    scrollToBottom();
  }

  function removeExistingQuickReplies() {
    const existing = chatContainer.querySelector('.quick-replies');
    if (existing) existing.remove();
  }

  function handleQuickReply(text) {
    addMessage(text, true);
    removeExistingQuickReplies();
    disableInput();
    const response = chatbot.generateResponse(text);
    addMessage(response);
  }

  function handleUserInput() {
    const text = userInput.value.trim();
    if (!text || isTyping) return;
    addMessage(text, true);
    userInput.value = '';
    removeExistingQuickReplies();
    disableInput();
    const response = chatbot.generateResponse(text);
    addMessage(response);
  }

  function disableInput() {
    isTyping = true;
    userInput.disabled = true;
    sendButton.disabled = true;
  }

  function enableInput() {
    isTyping = false;
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.focus();
  }
  
  function scrollToBottom() {
    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
  }

  function clearConversation() {
    if (confirm('Weet u zeker dat u het gesprek wilt wissen?')) {
      chatContainer.innerHTML = '';
      chatbot.clearSession();
      const welcomeResponse = chatbot.generateResponse("hallo");
      addMessage(welcomeResponse);
    }
  }

  // Event Listeners
  sendButton.addEventListener('click', handleUserInput);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleUserInput();
    }
  });
  clearButton.addEventListener('click', clearConversation);
  helpButton.addEventListener('click', () => {
      addMessage(chatbot.getHelpInfo());
  });

  // Initial greeting
  const welcomeResponse = chatbot.generateResponse("hallo");
  addMessage(welcomeResponse);
});

// Function for the email button (can be outside the main script)
function emailConversation() {
  const supportEmail = 'support@voorbeeld.nl'; // <-- CHANGE THIS
  const pageTitle = document.title;
  const currentDate = new Date().toLocaleDateString('nl-NL', { dateStyle: 'long' });
  const subject = `Chat Transcript: ${pageTitle} - ${currentDate}`;
  
  const messages = document.querySelectorAll('#chat-container .message-wrapper');
  if (messages.length === 0) {
    alert("Er is nog geen gesprek om te mailen.");
    return;
  }
  
  const transcript = Array.from(messages).map(wrapper => {
    const time = wrapper.querySelector('.message-time').textContent;
    const sender = wrapper.classList.contains('user-message-wrapper') ? 'U' : 'Assistent';
    const text = wrapper.querySelector('.user-message, .bot-message').textContent;
    return `[${time}] ${sender}: ${text}`;
  }).join('\n');
  
  const body = `Hieronder staat het transcript van mijn gesprek met de virtuele assistent:\n\n--------------------------------------------------\n${transcript}\n--------------------------------------------------\n\nMijn onbeantwoorde vraag is:\n\n`;
  const mailtoLink = `mailto:${supportEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoLink;
}
</script>

</body>
</html>
